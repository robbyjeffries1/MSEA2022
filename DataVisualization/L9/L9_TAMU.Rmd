---
title: "Texas Permit Data"
author: "Robby Jeffries"
date: "9/21/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
```

### Data Import

  This data was generated by the TAMU. You can search for it by "permit data".
  
```{r}
permits_raw <- read_csv("https://raw.githubusercontent.com/hadley/building-permits/master/dataPermit_full.csv")

```

* f1 = single family home, f24 = 2-4 family home, f5 = 5+ units
* units = # built
  * value = avg_value per unit
  * valchange = percent change from previous month
  
### Eliminate the change variables

```{r}
permits <- permits_raw %>% 
  select(-ends_with("change")) %>%
  tidyr::separate(date, c("month", "year"), 
                  "/",
                  convert = TRUE)

### NON SEQUITUR
### Camel case
# myFunctionDoesThis
### snake case
# my_function_does_this
```

### Now, let's do some basic EDA

```{r}
permits %>% count(year)
## THIS IS IDENTICAL TO
permits %>% group_by(year) %>% summarize(n = n()) %>% View()

permits %>% count(area) %>% arrange() %>% View()

# count within a count. Not only do you want to see all of the areas, you want to see how many of each unique area exists
permits %>% count(area) %>% count(n)

```

### Focus

Reduce our set of interest to single family homes

```{r}
ggplot(permits) + geom_line(aes(year + month/12, f1units, group = area))

```

### Zooming in

Let's 1) focus on large cities and 2) more recent data

This might be a mistake; for example, large cities might systemically over or under estimate something we care about when modeling.

```{r}
single_fams <- permits %>% 
  group_by(area) %>% 
  summarize(mean = mean(f1units)) %>%
  arrange(desc(mean))

permits_big <- permits %>%
  semi_join(single_fams %>% filter(mean > 200)) %>%
  mutate(date = year + (month - 1) / 12) %>%
  filter(date > 2000)


```

Let's replot a bit

```{r}
ggplot(permits_big, aes(date, f1units)) + 
  geom_line(aes(group = area)) + 
  scale_y_log10()

ggplot(permits_big, aes(date, f1units)) + 
  geom_line(aes(group = area), alpha = 1/6) + 
  scale_y_log10() +
  geom_smooth(se = FALSE)

```

### Is there a regular pattern?

Let's look at one city to start.

```{r}

houston <- permits_big %>%
  filter(str_detect(area, "Houston"))

ggplot(houston, aes(date, f1units)) + 
  geom_line(aes(group = area)) + 
  scale_y_log10() +
  geom_smooth(se = FALSE)

```

### Let's model

* It appears there's a seasonal pattern
* What's the lag between permitting and construction?
* What drives all this?

```{r}

houston_mod <- lm(log(f1units) ~ factor(month), data = houston)

houston %>% 
  add_predictions(houston_mod) %>% 
  ggplot(aes(date, pred)) +
  geom_line()

houston %>% 
  add_residuals(houston_mod) %>% 
  ggplot(aes(date, resid)) +
  geom_hline(yintercept = 0, size = 3, color = "white") +
  geom_line()
 
```

